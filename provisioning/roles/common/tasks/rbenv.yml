- name: ensure rbenv is installed
  sudo: no
  git: repo=git://github.com/sstephenson/rbenv.git
       dest=~/.rbenv
       version=master

- name: ensure .rbenv setting is in .bashrc
  sudo: no
  lineinfile: dest=~/.bashrc {{item}}
  with_items:
    - regexp='.rbenv/bin:' line='export PATH="$HOME/.rbenv/bin:$PATH"'
    - regexp='rbenv init -' line='eval "$(rbenv init -)"'
  notify:
    - source .bashrc

- name: ensure ruby-build is installed
  sudo: no
  git: repo=git://github.com/sstephenson/ruby-build.git
       dest=~/.rbenv/plugins/ruby-build
       version=master

- name: check current ruby version
  sudo: no
  shell: rbenv version | cut -f 1 -d ' '
  register: current_ruby_version

- name: ensure ruby is installed
  sudo: no
  shell: rbenv {{item}} {{ruby_version}}
  with_items:
    - install
    - global
  when: current_ruby_version.stdout != ruby_version

- name: check bundler is installed
  sudo: no
  shell: gem list | grep -q bundler; echo $?
  register: check_bundler

- name: ensure bundler is installed
  sudo: no
  shell: gem install bundler --no-ri --no-rdoc
  notify:
    - rbenv rehash
  when: check_bundler.stdout != "0"